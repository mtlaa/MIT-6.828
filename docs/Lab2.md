# Lab 2: 内存管理

## 引言
在这个实验中，你将为你的操作系统编写内存管理的代码。内存管理有两个组件。

第一个组件是内核的物理内存分配器，使内核能够分配内存然后再释放它。分配器将以 4096B 为单位运行，称为页。你的任务是维护数据结构，这个数据结构记录哪些物理页面是空闲的，哪些是已分配的，以及有多少进程共享每个分配的页面。你还将编写例程来分配和释放内存页面。

第二个组件是虚拟内存的管理，它将内核和用户软件使用的虚拟地址映射到物理内存中的地址。x86 硬件的内存管理单元 (MMU) 在指令使用内存时通过查找页表来执行映射。你将根据我们提供的规范修改JOS去设置MMU的页表。

## 开始
在这个和未来的实验中，你将逐步构建你的内核。我们也会提供给你一些附加资源。

分支`lab2`提供了几个新的源文件，需要把lab1中的更改合并到lab2中：
* inc/memlayout.h
* kern/pmap.c
* kern/pmap.h
* kern/kclock.h
* kern/kclock.c

`memlayout.h` 描述了您必须通过修改 `pmap.c` 来​​实现的虚拟地址空间的布局。 `memlayout.h` 和 `pmap.h` 定义了 `PageInfo` 结构，您将使用它来跟踪哪些物理内存页面是空闲的。 `kclock.c` 和 `kclock.h` 操纵 PC's battery-backed clock 和 CMOS RAM 硬件，其中 BIOS 记录 PC 包含的物理内存总量等。 `pmap.c` 中的代码需要读取这个设备硬件，以便计算出有多少物理内存，但是这部分代码已经为你完成了：您不需要了解 CMOS 硬件工作的细节。

请特别注意 `memlayout.h` 和 `pmap.h`，因为本实验要求您使用并理解它们包含的许多定义。您可能还想查看 `inc/mmu.h`，因为它还包含许多对本实验有用的定义。

## 实验要求
在本实验和后续实验中，完成实验中描述的所有常规练习和至少一个挑战问题。此外，写下对实验提出的问题的简短答案，并简短描述您为解决所选挑战问题所做的工作。

这个实验的目标应该是完善`pmap.c`

可以在`lab`目录下使用`make grade`进行评分。

# Part 1：物理内存管理
操作系统必须追踪物理内存的哪些部分是空闲的，哪些部分正在被使用。JOS使用页面粒度管理PC的物理内存，以便它可以使用MMU映射和保护每块分配的内存。

你现在将编写物理页面分配器。它使用 `struct PageInfo` 对象的链表跟踪哪些页面是空闲的（与 xv6 不同，这些对象本身不嵌入空闲页面中），每个对象对应一个物理页面。您需要先编写物理页面分配器，然后才能编写其余的虚拟内存实现，因为您的页表管理代码需要分配物理内存来存储页表（页表存储在内存中，需要为页表分配物理内存）。

> **练习1** 在文件 `kern/pmap.c` 中，你必须实现以下函数的代码。    
> `boot_alloc()`   
> `mem_init()` (only up to the call to check_page_free_list(1))   
> `page_init()`   
> `page_alloc()`   
> `page_free()`  
> 
> `check_page_free_list()` 和 `check_page_alloc()` 测试你的物理页面分配器。你应该启动 JOS 并查看 `check_page_alloc()` 是否报告成功。修复您的代码以使其通过。您可能会发现添加自己的 `assert()` 对验证自己的的假设是否正确很有帮助。

这个实验以及所有 6.828 的实验，都需要你做一些侦探工作来弄清楚你需要做什么。该练习没有指出你必须添加到 JOS 的代码的所有细节。也就是说对源码的注释要多加注意，注释里会有一些提示以及指出需要你要添加的代码。

## Part 2：虚拟内存